# Changelog

All notable changes to `calisero/laravel-sms` will be documented in this file.

## [Unreleased]
### Removed
- Internal logging (Log facade usage) from `SmsClient` and example subscriber; logging is now entirely user-managed.

### Added
- `calisero:sms:status {id}` command to fetch and display SMS status/details.

### Changed
- Test & verification commands rely solely on Calisero API validation (phone, code, attempts) with 422 responses and explicit messages.

## [1.1.1] - 2025-11-09

### Fixed
- **Verification methods** now correctly use SDK's `verifications()->create()` and `verifications()->validate()` methods
- Fixed `sendVerification()` to properly use `CreateVerificationRequest` DTO
- Fixed `checkVerification()` to properly use `VerificationCheckRequest` DTO and return `GetVerificationResponse`
- Updated test mocks to properly test verification functionality with correct SDK method calls
- Removed unused import in `ServiceProvider` to fix PHP CS Fixer violations

### Changed
- Improved verification method implementations to align with Calisero PHP SDK v2.x architecture
- Enhanced test coverage for verification methods with proper mocking of SDK services
- Better error handling in verification methods with consistent logging

### Technical
- Tests now properly mock `\Calisero\Sms\Services\VerificationService` for verification operations
- Verification methods now return proper DTO responses instead of raw arrays
- All tests passing (28 tests, 94 assertions)
- Code style compliance verified with PHP CS Fixer

## [1.1.0] - 2025-10-09

### Added
- **Verification API support** - Send and check verification codes for 2FA
  - `sendVerification()` method to send auto-generated codes via SMS
  - `checkVerification()` method to verify codes
  - Support for `brand` (simple name, max 120 chars) or `template` (custom message with {code}, max 600 chars)
  - Support for `expires_in` parameter (1-10 minutes, default 5)
  - Codes are automatically generated by Calisero (6 characters, case-insensitive, time-limited)
- **New Artisan commands**
  - `calisero:verification:send` - Send verification codes with brand or template
  - `calisero:verification:check` - Check verification codes from CLI
- **Comprehensive examples** in `examples/` directory
  - `verification_with_brand.php` - Using brand name
  - `verification_with_template.php` - Using custom template
  - `verification_check_with_errors.php` - Complete error handling
  - `complete_2fa_flow.php` - Full 2FA implementation
  - `examples/README.md` - Detailed documentation for all examples
- **Complete 2FA implementation example** in README with all exception types
- **Enhanced documentation** with verification use cases and examples

### Changed
- Updated `SmsClient` interface to include verification methods with brand/template support
- Enhanced README with comprehensive 2FA flow examples and error handling
- Improved logging for all operations using configured log channel consistently
- Better exception handling with Calisero-specific exceptions (ValidationException, NotFoundException, RateLimitedException)
- Fixed `deleteMessage()` to use configured log channel

### Technical
- Compatible with latest `calisero/calisero-php` v2.x with verification support
- Maintains backward compatibility with existing SMS functionality
- Verification codes are SMS-only
- Code generation and expiration handled by Calisero API
- Either `brand` OR `template` (with {code} placeholder) is required
- Template must contain `{code}` placeholder for code insertion
- Template max length: 600 characters
- Brand max length: 120 characters
- `expires_in` range: 1-10 minutes (default: 5)
- Verification codes: 6 characters, alphanumeric, **case-insensitive** (e.g., SBMH0f, sbmh0f, SbMh0F are all valid)

## [1.0.4] - 2025-09-25
### Documentation
- Added comprehensive environment variables reference table in README
- Enhanced installation and configuration documentation with complete variable listing
- Improved README structure with clearer sections for all configuration options
- Added detailed descriptions for all available environment variables
- Organized configuration variables by category (Required, Connection, Webhook, Monitoring, Logging)

### Added
- Complete environment variables documentation in README.md
- Configuration reference table with descriptions and default values
- Enhanced setup instructions with all available options

### Improved
- Better organization of configuration documentation
- Clearer categorization of environment variables
- More comprehensive setup guide for new users

## [1.0.3] - 2025-09-25
### Added
- Full PHP 8.4 compatibility alongside existing PHP 8.2 and 8.3 support
- Enhanced memory management for PHP CS Fixer operations
- Improved CI/CD pipeline with comprehensive PHP version matrix testing

### Changed
- Updated PHP version constraint to `^8.2` (supports 8.2, 8.3, and 8.4)
- Optimized PHP CS Fixer configuration with proper memory allocation
- Enhanced GitHub Actions workflow to test against PHP 8.2, 8.3, and 8.4
- Improved webhook token validation test coverage and error messages
- Updated composer scripts for better performance and reliability

### Fixed
- Resolved PHP CS Fixer memory exhaustion issues on larger codebases
- Fixed webhook token validation test assertions to match actual error responses
- Cleaned up empty test files that were causing PHPUnit warnings
- Improved code formatting consistency across all source files

### Technical
- Updated `composer.json` to support latest PHP versions while maintaining Laravel 12.x compatibility
- Enhanced CI pipeline stability with proper dependency version constraints
- Improved development workflow with optimized quality assurance scripts
- Added proper timeout handling for long-running CS Fixer operations

### Requirements
- PHP 8.2, 8.3, or 8.4
- Laravel 12.x
- Calisero PHP SDK ^2.0

## [1.0.2] - 2025-09-25
### Added
- Optional webhook token authentication: set `CALISERO_WEBHOOK_TOKEN=your-secret` (config: `calisero.webhook.token`) to require a matching `?token=your-secret` query parameter on the webhook route. Middleware `ValidateWebhookToken` is automatically applied only when a token is configured, preserving previous unauthenticated behavior when absent.

### Notes
- Enables lightweight shared-secret protection without reintroducing the removed HMAC signature scheme.

## [1.0.1] - 2025-09-25
### Removed
- Signature-based webhook verification (middleware & HMAC secret) – webhook endpoint is now unauthenticated by default.
- `calisero:webhook:verify` artisan command.
- Webhook secret / verify configuration keys.

### Added
- Automatic `callback_url` injection when `CALISERO_WEBHOOK_ENABLED=true` and no explicit callback provided.
- Credit monitoring events: `CreditLow`, `CreditCritical` with configurable thresholds.
- `MessageSent` event (lifecycle expansion: sent → delivered/failed).
- Multilingual validation messages (English & Romanian) – publishable via `calisero-translations` tag.
- Configurable webhook enabling flag (`CALISERO_WEBHOOK_ENABLED`).

### Changed
- Webhook routes now register only when explicitly enabled (no secret required).
- `SmsClient` sends structured DTO requests and supports snake_case / camelCase optional parameters.
- Updated README & examples to reflect removal of signature verification and new behaviors.
- Improved type declarations for `SmsClient` contract & implementation.

### Fixed
- Normalized parameter naming (`schedule_at`, `callback_url`) in notification channel.
- Removed stale comments and deprecated code blocks prior to publication.

### Notes
- This release includes a breaking change if you depended on prior signature verification; add your own middleware (token/IP allow‑list) if needed.

## [1.0.0] - 2025-09-??
### Added
- Initial release
- Laravel 12.x support
- SMS sending via Facade, Notification channel, and direct client
- Webhook handling (basic, unauthenticated in current revision)
- Validation rules for phone numbers (E.164) and sender IDs
- Artisan command for test SMS sending
- Comprehensive test suite with Orchestra Testbench
- GitHub Actions CI pipeline
- PHPStan static analysis & PHP CS Fixer formatting
